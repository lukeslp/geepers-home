# Sensor Context Schema

Structured data format for sensor readings and situation reports.

## Overview

The sensor context provides a structured representation of all sensor data organized by category. This format is used for:
- LLM chat context (`/api/situation`)
- Web UI state management
- Data logging and analysis

## Full Context Structure

```typescript
interface SensorContext {
  timestamp: string;          // ISO 8601 timestamp
  environment: EnvironmentData;
  motion: MotionData;
  camera: CameraData;
  system: SystemData;
  network: NetworkData;
  weather: WeatherData;
}
```

## Environment Data

Temperature, humidity, pressure, light, UV, air quality.

```typescript
interface EnvironmentData {
  temperature?: number;        // Celsius (BME280)
  humidity?: number;           // Percentage (BME280)
  pressure?: number;           // hPa (BME280)
  light_level?: number;        // Lux (TSL25911)
  uv_index?: number;           // UV Index 0-11+ (LTR390)
  air_quality_voc?: number;    // VOC raw value (SGP40, higher is better)
}
```

### Example
```json
{
  "temperature": 22.5,
  "humidity": 45.0,
  "pressure": 1013.2,
  "light_level": 350.5,
  "uv_index": 2.3,
  "air_quality_voc": 28500
}
```

### Field Ranges & Thresholds

| Field | Unit | Good Range | Warning | Critical |
|-------|------|------------|---------|----------|
| temperature | °C | 18-24 | 15-18, 24-28 | <15, >28 |
| humidity | % | 40-60 | 30-40, 60-70 | <30, >70 |
| pressure | hPa | 1000-1030 | 980-1000, 1030-1050 | <980, >1050 |
| light_level | lux | 200-500 | 10-200, 500-1000 | <10, >1000 |
| uv_index | - | 0-2 | 3-5 | 6-7, 8+ extreme |
| air_quality_voc | raw | >30000 | 25000-30000 | <25000 |

## Motion Data

Currently empty (future: PIR, reed switch, touch sensor integration).

```typescript
interface MotionData {
  // Reserved for future motion sensor integration
  pir_motion?: boolean;
  reed_open?: boolean;
  touch_active?: boolean;
}
```

## Camera Data

Live camera feed, motion detection, scene description.

```typescript
interface CameraData {
  motion_detected: boolean;      // Motion detection flag
  motion_level: number;          // Motion intensity (0-100)
  has_frame: boolean;            // Frame available
  scene_description?: string;    // AI-generated scene description
}
```

### Example
```json
{
  "motion_detected": false,
  "motion_level": 0.8,
  "has_frame": true,
  "scene_description": "A well-lit room with a desk and computer monitor. Natural light coming from the left side."
}
```

### Motion Detection

- `motion_detected`: True if motion level exceeds threshold (default: 3.0)
- `motion_level`: Frame difference magnitude
- Computed from RGB24 frame differencing (numpy)

### Scene Description

- Generated by VPS vision API (xAI grok-2-vision or OpenAI gpt-4o)
- Updated every 60 seconds (configurable in `dashboard.yaml`)
- Brief descriptions (1-2 sentences)

## System Data

Raspberry Pi system metrics.

```typescript
interface SystemData {
  cpu_temp?: number;           // CPU temperature (°C)
  ram_percent?: number;        // RAM usage (%)
  disk_percent?: number;       // Disk usage (%)
  uptime_seconds?: number;     // System uptime (seconds)
}
```

### Example
```json
{
  "cpu_temp": 52.3,
  "ram_percent": 35.2,
  "disk_percent": 42.1,
  "uptime_seconds": 86400
}
```

### System Thresholds

| Metric | Warning | Critical |
|--------|---------|----------|
| cpu_temp | >70°C | >80°C |
| ram_percent | >75% | >90% |
| disk_percent | >80% | >95% |

## Network Data

Network connectivity and performance.

```typescript
interface NetworkData {
  ping_ms?: number;            // Ping latency to VPS (ms)
  ip_address?: string;         // Local IP address
  throughput_mbps?: number;    // Network throughput (Mbps)
}
```

### Example
```json
{
  "ping_ms": 12.5,
  "ip_address": "192.168.1.100",
  "throughput_mbps": 45.2
}
```

### Network Thresholds

| Metric | Good | Warning | Poor |
|--------|------|---------|------|
| ping_ms | <20 | 20-50 | >50 |
| throughput_mbps | >30 | 10-30 | <10 |

## Weather Data

External weather from Open-Meteo API.

```typescript
interface WeatherData {
  temperature?: number;        // Outdoor temperature (°C)
  windspeed?: number;          // Wind speed (km/h)
  winddirection?: number;      // Wind direction (degrees)
  weathercode?: number;        // WMO weather code
  is_day?: number;             // 1 = day, 0 = night
  time?: string;               // ISO 8601 timestamp
}
```

### Example
```json
{
  "temperature": 18.5,
  "windspeed": 5.2,
  "winddirection": 180,
  "weathercode": 0,
  "is_day": 1,
  "time": "2026-02-12T03:00"
}
```

### WMO Weather Codes

| Code | Description |
|------|-------------|
| 0 | Clear sky |
| 1-3 | Partly cloudy |
| 45, 48 | Fog |
| 51-55 | Drizzle |
| 61-65 | Rain |
| 71-77 | Snow |
| 80-82 | Rain showers |
| 95-99 | Thunderstorm |

## Individual Sensor Reading Format

Each sensor publishes data in this format:

```typescript
interface SensorReading {
  [field: string]: any;        // Sensor-specific fields
  timestamp: string;           // ISO 8601 timestamp
  source_id: string;           // Source identifier (e.g., "sensor.bme280")
}
```

### Example: BME280
```json
{
  "temperature": 22.5,
  "humidity": 45.0,
  "pressure": 1013.2,
  "timestamp": "2026-02-12T03:45:12.123456",
  "source_id": "sensor.bme280"
}
```

### Example: Camera
```json
{
  "motion_detected": false,
  "motion_level": 0.8,
  "frame_jpeg": "<bytes>",
  "timestamp": "2026-02-12T03:45:13.456789",
  "source_id": "camera.feed"
}
```

## Sensor Source IDs

| Source ID | Type | Fields |
|-----------|------|--------|
| sensor.bme280 | I2C | temperature, humidity, pressure |
| sensor.tsl25911 | I2C | lux, infrared, visible |
| sensor.ltr390 | I2C | uvi, uva |
| sensor.sgp40 | I2C | voc_raw |
| camera.feed | USB | motion_detected, motion_level, frame_jpeg |
| camera.vision | API | description |
| system.stats | /proc | cpu_temp, ram_percent, disk_percent, uptime |
| net.health | Network | ping, ip, throughput |
| api.weather | REST | temperature, windspeed, weathercode |

## LLM Context Format

When sending sensor data to the LLM chat API, use the full context structure:

```json
{
  "message": "What's the air quality like?",
  "context": {
    "timestamp": "2026-02-12T03:45:15.123456",
    "environment": {
      "temperature": 22.5,
      "humidity": 45.0,
      "air_quality_voc": 28500
    },
    "camera": {
      "motion_detected": false,
      "scene_description": "A well-lit room with a desk."
    },
    "system": {
      "cpu_temp": 52.3,
      "ram_percent": 35.2
    },
    "network": {
      "ping_ms": 12.5
    },
    "weather": {
      "temperature": 18.5,
      "weathercode": 0
    }
  }
}
```

The LLM can reference all available sensor data to provide contextual responses.

## Historical Data Format

Sensor history is stored as a time series:

```typescript
interface SensorHistory {
  source_id: string;
  count: number;
  data: HistoryPoint[];
}

interface HistoryPoint {
  timestamp: number;           // Unix timestamp (seconds)
  data: Record<string, any>;   // Sensor fields at that time
}
```

### Example
```json
{
  "source_id": "sensor.bme280",
  "count": 3,
  "data": [
    {
      "timestamp": 1707709510.123,
      "data": {
        "temperature": 22.3,
        "humidity": 44.8,
        "pressure": 1013.1
      }
    },
    {
      "timestamp": 1707709512.456,
      "data": {
        "temperature": 22.4,
        "humidity": 44.9,
        "pressure": 1013.15
      }
    },
    {
      "timestamp": 1707709514.789,
      "data": {
        "temperature": 22.5,
        "humidity": 45.0,
        "pressure": 1013.2
      }
    }
  ]
}
```

Used for graphing and trend analysis.

## SSE Event Format

Server-Sent Events use this format:

```
event: sensor_update
data: {"source_id": "sensor.bme280", "temperature": 22.5, ...}

event: camera_motion
data: {"motion_detected": true, "level": 5.2}
```

Each event contains:
- `event`: Event type (`sensor_update`, `camera_motion`)
- `data`: JSON-encoded sensor reading

## Data Update Frequencies

| Source | Default Interval | Configurable |
|--------|-----------------|--------------|
| BME280 | 2000ms | Yes |
| TSL25911 | 2000ms | Yes |
| LTR390 | 2000ms | Yes |
| SGP40 | 2000ms | Yes |
| Camera | 100ms | Yes |
| Vision | 60s | Yes |
| System | 5s | Yes |
| Network | 30s | Yes |
| Weather | 600s (10min) | Yes |

Intervals are configured in `dashboard.yaml` under each source's `interval` field (in seconds).

## Notes

- All temperature values are in Celsius
- All timestamps are ISO 8601 format (`YYYY-MM-DDTHH:MM:SS.ffffff`)
- Missing fields indicate sensor not available or failed reading
- JPEG data in `frame_jpeg` is base64-encoded when serialized to JSON (binary when accessed directly)
- VOC values are raw ADC readings (higher = better air quality, counter-intuitive)
- UV index scale: 0-2 low, 3-5 moderate, 6-7 high, 8-10 very high, 11+ extreme
